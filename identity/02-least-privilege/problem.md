# Generating a Least-Privilege IAM Policy

## Problem

You want to grant a role or user only the permissions they actually need. Instead of guessing or using over‑permissive policies, you can analyze CloudTrail logs to derive a policy based on actions that have been used.

## Solution

Follow these steps using AWS Access Analyzer:

1. Identify the principal whose activity you want to analyze (for example, a role ARN).
2. Start a policy generation job with `aws accessanalyzer start-policy-generation`, specifying the principal ARN and CloudTrail details.
3. Wait for the job to complete by polling `aws accessanalyzer get-generated-policy`.
4. Retrieve the generated policy JSON from the `generatedPolicyResult.generatedPolicy.document` field.
5. Review the actions and resources; remove unused actions or refine resource ARNs.
6. Create the policy with `aws iam create-policy` and attach it to the principal with `aws iam attach-role-policy`.
7. Optionally, use Terraform’s `aws_iam_policy` and `aws_iam_role_policy_attachment` resources to codify the policy.

### Terraform example

```
resource "aws_iam_policy" "least_privilege" {
  name        = "LeastPrivilegeForDev"
  description = "Policy generated by Access Analyzer"
  policy      = file("generated-policy.json")
}

resource "aws_iam_role_policy_attachment" "attach_least_privilege" {
  role       = aws_iam_role.developer.name
  policy_arn = aws_iam_policy.least_privilege.arn
}
```

## Why this works & trade-offs

Access Analyzer reads CloudTrail events and constructs a policy containing only the actions actually used. This helps enforce least privilege and reduces risk of unused permissions. However, be sure your CloudTrail covers all relevant services and time windows. If an action hasn’t been used yet, it will not appear in the generated policy, so you may need to add missing actions manually.

## Verification

- Use `aws iam simulate-principal-policy --policy-source-arn <principal-arn> --action-names <service:Operation> --resource-arns <arn>` to ensure necessary actions evaluate to “allowed” and unnecessary actions evaluate to “implicitDeny” or “explicitDeny”.
- Run a few typical operations with the principal; confirm they succeed.
- Monitor CloudTrail after deployment to watch for unexpected “Access Denied” events.
